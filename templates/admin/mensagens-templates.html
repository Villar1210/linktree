{% extends 'base.html' %}
{% block title %}Templates de Mensagens - Admin{% endblock %}
{% block content %}
<div class="admin-container">
    <div class="container">
        <div class="page-header">
            <h1><i class="fas fa-comment-dots"></i> Templates de Mensagens WhatsApp</h1>
            <p>Gerencie e personalize mensagens automáticas para campanhas, clientes e corretores</p>
        </div>
        <!-- Novo Template -->
        <section class="admin-section">
            <div class="section-header">
                <h2>Novo Template</h2>
            </div>
            <form method="POST" class="admin-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="nome"><i class="fas fa-font"></i> Nome *</label>
                        <input type="text" id="nome" name="nome" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="titulo"><i class="fas fa-heading"></i> Título *</label>
                        <input type="text" id="titulo" name="titulo" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="categoria"><i class="fas fa-tag"></i> Categoria *</label>
                        <input type="text" id="categoria" name="categoria" class="form-control" placeholder="campanha, cliente, corretor" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="conteudo"><i class="fas fa-align-left"></i> Conteúdo *</label>
                    <textarea id="conteudo" name="conteudo" class="form-control" rows="3" required></textarea>
                    <small>Use <code>{{variavel}}</code> para variáveis dinâmicas.</small>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i> Criar Template</button>
                </div>
            </form>
        </section>
        <!-- Templates Cadastrados -->
        <section class="admin-section">
            <div class="section-header">
                <h2>Templates Cadastrados</h2>
                <span class="count">{{ templates|length }}</span>
            </div>
            {% if templates %}
                <div class="templates-grid">
                    {% for t in templates %}
                        <div class="template-card" data-template-id="{{ t.id }}">
                            <div class="template-header">
                                <h3>{{ t.titulo }}</h3>
                                <span class="template-categoria">{{ t.categoria|title }}</span>
                                {% if t.ativo %}<span class="badge badge-success">Ativo</span>{% else %}<span class="badge badge-danger">Inativo</span>{% endif %}
                            </div>
                            <div class="template-content">
                                <div><strong>Nome:</strong> {{ t.nome }}</div>
                                <div><strong>Conteúdo:</strong> {{ t.conteudo[:120] }}{% if t.conteudo|length > 120 %}...{% endif %}</div>
                            </div>
                            <div class="template-actions">
                                <button class="btn btn-sm btn-outline edit-template-btn" onclick="editarTemplate({{ t.id }})">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                                <button class="btn btn-sm btn-danger delete-template-btn" onclick="deletarTemplate({{ t.id }})">
                                    <i class="fas fa-trash"></i> Deletar
                                </button>
                            </div>
                            <!-- Edit Form (Hidden) -->
                            <div class="template-edit-form" style="display: none;" data-template-id="{{ t.id }}">
                                <form method="POST" action="/admin/mensagens-templates/{{ t.id }}/editar">
                                    <div class="form-group">
                                        <label>Nome</label>
                                        <input type="text" name="nome" class="form-control" value="{{ t.nome }}">
                                    </div>
                                    <div class="form-group">
                                        <label>Tipo</label>
                                        <input type="text" name="tipo" class="form-control" value="{{ t.tipo }}">
                                    </div>
                                    <div class="form-group">
                                        <label>Mensagem</label>
                                        <textarea name="mensagem" class="form-control" rows="3">{{ t.conteudo }}</textarea>
                                    </div>
                                    <div class="form-group">
                                        <label>Variáveis (separadas por vírgula)</label>
                                        <input type="text" name="variaveis" class="form-control" value="{{ t.variaveis|join(', ') if t.variaveis else '' }}">
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" name="destaque" class="form-check-input" {% if t.destaque %}checked{% endif %}>
                                        <label class="form-check-label">Destaque</label>
                                    </div>
                                    <div class="form-actions" style="margin-top: 1rem;">
                                        <button type="submit" class="btn btn-primary btn-sm">Salvar</button>
                                        <button type="button" class="btn btn-outline btn-sm cancel-edit-btn" onclick="cancelarEdicaoTemplate({{ t.id }})">Cancelar</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-comment-dots"></i>
                    <p>Nenhum template cadastrado ainda</p>
                </div>
            {% endif %}
        </section>
    </div>
</div>
<style>
.templates-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1.5rem;
}
.template-card {
    background: white;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    padding: 1.5rem;
    transition: all 0.3s;
    border-left: 4px solid var(--primary-color);
}
.template-card:hover {
    box-shadow: var(--shadow-lg);
}
.template-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
}
.template-header h3 {
    margin: 0;
    flex: 1;
}
.template-categoria {
    font-size: 0.85rem;
    color: var(--gray-600);
}
.template-content {
    margin-bottom: 1rem;
}
.template-info {
    margin: 0.5rem 0;
}
.info-item {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
}
.template-dates {
    padding: 0.5rem;
    background: var(--gray-100);
    border-radius: 4px;
    margin: 0.5rem 0;
}
.template-actions {
    display: flex;
    gap: 0.5rem;
}
.template-edit-form {
    margin-top: 1rem;
    padding: 1rem;
    background: var(--gray-100);
    border-radius: var(--border-radius);
}
.template-edit-form form {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}
</style>
<script>
// Editar template
function editarTemplate(templateId) {
    const form = document.querySelector(`.template-edit-form[data-template-id="${templateId}"]`);
    const card = document.querySelector(`.template-card[data-template-id="${templateId}"]`);
    form.style.display = 'block';
    card.querySelector('.template-content').style.display = 'none';
    card.querySelector('.template-actions').style.display = 'none';
}
// Cancelar edição
function cancelarEdicaoTemplate(templateId) {
    const form = document.querySelector(`.template-edit-form[data-template-id="${templateId}"]`);
    const card = document.querySelector(`.template-card[data-template-id="${templateId}"]`);
    form.style.display = 'none';
    card.querySelector('.template-content').style.display = 'block';
    card.querySelector('.template-actions').style.display = 'flex';
}
// Deletar template
async function deletarTemplate(templateId) {
    if (!confirm('Tem certeza que deseja deletar este template?')) return;
    try {
        const response = await fetch(`/admin/mensagens-templates/${templateId}/deletar`, {
            method: 'DELETE'
        });
        const data = await response.json();
        if (response.ok) {
            alert(data.mensagem);
            location.reload();
        } else {
            alert('Erro: ' + data.mensagem);
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao deletar template');
    }
}
</script>
{% endblock %}